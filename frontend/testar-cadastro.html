<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Testar Cadastro</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <h1>Testar Cadastro</h1>
  <form id="cadastro-form">
    <input type="text" name="nome" placeholder="Nome" required />
    <input type="email" name="email" placeholder="E-mail" required />
    <input type="text" name="telefone" placeholder="Telefone" required />
    <button type="submit">Enviar</button>
  </form>
  <pre id="resultado"></pre>
  <script type="module">
    import { API_BASE } from './settings.js';

    const form = document.getElementById('cadastro-form');
    const output = document.getElementById('resultado');

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const nome = form.nome.value;
      const email = form.email.value;
      const telefone = form.telefone.value;
      const pin = prompt('PIN admin?');
      const headers = {
        'Content-Type': 'application/json',
        'x-admin-pin': pin || ''
      };

      async function call(url, body){
        try {
          const res = await fetch(url, {
            method: 'POST',
            headers,
            body: JSON.stringify(body)
          });
          const text = await res.text();
          try {
            return JSON.stringify(JSON.parse(text), null, 2);
          } catch (_) {
            if (text.trim().startsWith('<')) {
              return 'A API respondeu HTML/erro. Verifique a URL do proxy e CORS.';
            }
            return text;
          }
        } catch (err) {
          return 'Erro: ' + err.message;
        }
      }

      output.textContent = 'Enviando...';
      const clienteResp = await call(`${API_BASE}/admin/clientes`, { nome, email, telefone });
      output.textContent = 'Cliente:\n' + clienteResp + '\n\n';
      const assinaturaResp = await call(`${API_BASE}/admin/assinatura`, {
        documento: telefone,
        plano: 'ESSENCIAL',
        forma_pagamento: 'PIX',
        valor: 0
      });
      output.textContent += 'Assinatura:\n' + assinaturaResp;
    });
  </script>
</body>
</html>
